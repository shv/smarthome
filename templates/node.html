{% extends "wrapper.html" %}

{% block content %}
    <h1>Node {{ node_id }}</h1>
    <ul id='nodes'></ul>
    <ul id='values'></ul>
    <div id="lamps"></div>
    <script>
        $.get("/api/nodes/{{ node_id }}",
            function (data, status) {
                console.log("Data: " + data + "\nStatus: " + status);
                var nodes_el = document.getElementById('nodes')
                var node_el = document.createElement('li')
                var content = document.createTextNode(
                    "ID: " + data["id"] + ", url: " + data["url"] + ", is_active: " + data["is_active"]
                )
                node_el.appendChild(content)
                nodes_el.appendChild(node_el)
            }
        );

        $.get("/api/nodes/{{ node_id }}/current-values",
            function (data, status) {
                console.log("Data: " + data + "\nStatus: " + status);
                var nodes_el = document.getElementById('values')
                data["data"].forEach(function (currentValue, index, arr) {
                    console.log(currentValue)
                    var node_el = document.createElement('li')
                    var value_label_el = document.createElement('span')
                    var value_label_content = document.createTextNode(
                        "ID: " + currentValue["id"] + ", " + currentValue["name"] + ": "
                    )
                    value_label_el.appendChild(value_label_content)
                    var value_value_el = document.createElement('span')
                    var value_value_content = document.createTextNode(currentValue["value"])
                    value_value_el.appendChild(value_value_content)
                    value_value_el.id = "current-value-" + currentValue["id"]
                    node_el.appendChild(value_label_el)
                    node_el.appendChild(value_value_el)
                    nodes_el.appendChild(node_el)
                });
            }
        );
        $.get("/api/nodes/{{ node_id }}/lamps",
            function (data, status) {
                console.log("Data: " + data + "\nStatus: " + status);
                var lamps_el = document.getElementById('lamps')
                data["data"].forEach(function (currentValue, index, arr) {
                    console.log(currentValue)
                    var lamp_div_el = document.createElement('div')
                    var lamp_input_el = document.createElement('input')
                    lamp_input_el.type = "checkbox";
                    lamp_input_el.dataset.id = currentValue["id"];
                    lamp_input_el.id = "lamp-" + currentValue["id"];
                    lamp_input_el.onchange = sendMessage;
                    if (currentValue["value"]) {
                        lamp_input_el.checked = true
                    }
                    var lamp_label_el = document.createElement('label')
                    lamp_label_el.for = "lamp-" + currentValue["id"];
                    var lamp_label_text = document.createTextNode(
                        "Lamp: " + currentValue["id"] + ", " + currentValue["name"] + ", v: " + currentValue["value"]
                    )
                    lamp_label_el.appendChild(lamp_label_text)
                    lamp_div_el.appendChild(lamp_input_el)
                    lamp_div_el.appendChild(lamp_label_el)
                    lamps_el.appendChild(lamp_div_el)
                });
            }
        );
        function sendMessage(event) {
            var obj = this;
            console.log(obj)
            ws.send(JSON.stringify({
                "request_id": "1",
                "action": "send_lamps_state_to_nodes",
                "data": {"lamps": [{"id": obj.dataset.id, "value": obj.checked?1:0}]}
            }))
            event.preventDefault()
        }

    </script>
{% endblock %}
